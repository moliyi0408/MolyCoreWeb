@model MolyCoreWeb.Models.ViewModels.StockViewModel

@{
    ViewData["Title"] = "Stock List";
}

<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
@*     <button id="btnGetBusinessIndicators" onclick="getBusinessIndicators()">Get Business Indicators</button>*@    
    <button id="btnUpdateBusinessIndicators" class="btn btn-default" onclick="updateBusinessIndicators()">更新經濟指標</button>
    <div id="business-indicators-list" style="display: none;">
        <!-- 這裡會顯示獲取到的經濟指標 -->
    </div>

    <div class="row">
        <div class="col-md-3">
            <label for="Q_MARKET_TYPE">市場別</label>
            <select id="Q_MARKET_TYPE" class="form-control">
                <option value="TWSE">證交所</option>
                <option value="OTC">櫃買中心</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="Q_ASSETS_TYPE">資產別</label>
            <select id="Q_ASSETS_TYPE" class="form-control">
                <option value="股票">股票</option>
                <option value="ETF">ETF</option>
            </select>
        </div>
        <div class="col-md-6">
            <br />
            <div class="row">
                <div class="col-md-2">
                    <button type="button" class="btn btn-default" onclick="getList()">查詢</button>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-default" onclick="updateData()">更新</button>
                </div>
                <div class="col-md-2">
                    <div id="message"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="result-panel" class="panel panel-default" style="display:none;">
        <div class="panel-heading">
            <span id="cname">清單</span>
            <div style="float:right;">
                總筆數: <span id="rowcnt"></span>
            </div>
        </div>
        <div class="panel-body">
            <input type="text" id="stock-search" class="form-control" placeholder="搜索股票" onkeyup="searchStock()">
            <table class="table">
                <thead>
                    <tr>
                        <th>代碼</th>
                        <th>名稱</th>
                        <th>市場別</th>
                        <th>資產別</th>
                        <th>上市日</th>
                        <th>產業別</th>
                        <th>CFICode</th>
                        <th>國際證券辨識號碼</th>
                    </tr>
                </thead>
                <tbody id="stock-list">
                </tbody>
            </table>
        </div>
    </div>

    <script>

        //頁面加載完成後，自動執行
        $(document).ready(function () {
            getBusinessIndicators();
        })

        function getList() {
            var marketType = $('#Q_MARKET_TYPE').val();
            var assetsType = $('#Q_ASSETS_TYPE').val();

            $('#message').text('查詢中...');

            $.ajax({
                url: '@Url.Action("GetList", "Stock")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    Q_MARKET_TYPE: marketType,
                    Q_ASSETS_TYPE: assetsType
                }),
                success: function (result) {
                    $('#result-panel').show();
                    var stockList = $('#stock-list');
                    stockList.empty();

                    if (result.gridList && result.gridList.length > 0) {
                        let rowsHtml = result.gridList.map(stock => `
                                    <tr>
                                        <td class="stock-id">${stock.stocK_CODE}</td>
                                        <td class="stock-name">${stock.stocK_NAME}</td>
                                        <td>${stock.markeT_TYPE}</td>
                                        <td>${stock.assetS_TYPE}</td>
                                        <td>${stock.publiC_DATE}</td>
                                        <td>${stock.industry}</td>
                                        <td>${stock.cfI_CODE}</td>
                                        <td>${stock.isiN_CODE}</td>
                                    </tr>
                                `).join('');

                        stockList.html(rowsHtml);
                        $('#rowcnt').text(result.gridList.length);
                    } else {
                        stockList.html('<tr><td colspan="8">沒有找到資料</td></tr>');
                    }
                    $('#message').text('查詢完畢');
                },
                error: function (xhr, status, error) {
                    console.error('查詢失敗:', error);
                    alert('查詢失敗');
                    $('#message').text('查詢失敗');
                }
            });
        }

        function updateData() {
            $('#message').text('股票數據更新中...');

            $.ajax({
                url: '@Url.Action("UpdateData", "Stock")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    Q_MARKET_TYPE: $('#Q_MARKET_TYPE').val(),
                    Q_ASSETS_TYPE: $('#Q_ASSETS_TYPE').val()
                }),
                success: function (response) {
                    alert('股票數據已更新');
                    $('#message').text('股票清單更新完畢');
                },
                error: function (xhr, status, error) {
                    alert('更新股票數據失敗');
                    $('#message').text('更新失敗：' + xhr.responseText);
                }
            });
        }

        function searchStock() {
            var input = document.getElementById("stock-search");
            var filter = input.value.toUpperCase();
            var table = document.getElementById("stock-list");
            var tr = table.getElementsByTagName("tr");

            for (var i = 0; i < tr.length; i++) {
                var tdId = tr[i].getElementsByClassName("stock-id")[0];
                var tdName = tr[i].getElementsByClassName("stock-name")[0];
                if (tdId || tdName) {
                    var txtValueId = tdId ? (tdId.textContent || tdId.innerText) : "";
                    var txtValueName = tdName ? (tdName.textContent || tdName.innerText) : "";

                    if (txtValueId.toUpperCase().indexOf(filter) > -1 || txtValueName.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function getBusinessIndicators() {
            $('#message').text('正在獲取經濟指標清單...');
            $.ajax({
                url: '@Url.Action("GetBusinessIndicatorList", "Stock")',
                type: 'POST',
                contentType: 'application/json',
                success: function (result) {
                    $('#business-indicators-list').show();
                    var table = $('<table>').addClass('table');
                    var header = $('<thead>').append(
                        $('<tr>').append(
                            $('<th>').text('Date'),
                            $('<th>').text('LEI CCI'),
                            $('<th>').text('LEI Ex Trend'),
                            $('<th>').text('CEI CCI'),
                            $('<th>').text('CEI Ex Trend'),
                            $('<th>').text('LAG CCI'),
                            $('<th>').text('LAG Ex Trend'),
                            $('<th>').text('BCS Composite Score'),
                            $('<th>').text('BCS Signal')
                        )
                    );
                    var body = $('<tbody>');

                    if (result && result.length > 0) {
                        result.forEach(indicator => {
                            var row = $('<tr>').append(
                                $('<td>').text(indicator.date),
                                $('<td>').text(indicator.leI_CCI),
                                $('<td>').text(indicator.leI_Ex_Trend),
                                $('<td>').text(indicator.ceI_CCI),
                                $('<td>').text(indicator.ceI_Ex_Trend),
                                $('<td>').text(indicator.laG_CCI),
                                $('<td>').text(indicator.laG_Ex_Trend),
                                $('<td>').text(indicator.bcS_Composite_Score),
                                $('<td>').text(indicator.bcS_Signal)
                            );
                            body.append(row);
                        });
                    } else {
                        var row = $('<tr>').append(
                            $('<td>').attr('colspan', '9').text('沒有找到經濟指標資料')
                        );
                        body.append(row);
                    }

                    table.append(header).append(body);
                    $('#business-indicators-list').html(table);
                    $('#message').text('經濟指標清單獲取完畢');
                },
                error: function (xhr, status, error) {
                    console.error('獲取經濟指標失敗:', error);
                    alert('獲取經濟指標失敗');
                    $('#message').text('獲取經濟指標失敗');
                }
            });
        }

        function updateBusinessIndicators() {
            $('#message').text('正在更新經濟指標...');

            $.ajax({
                url: '@Url.Action("UpdateBusinessIndicator", "Stock")',
                type: 'POST',
                contentType: 'application/json',
                success: function (response) {
                    alert('經濟指標已更新');
                    $('#message').text('經濟指標更新完畢');
                },
                error: function (xhr, status, error) {
                    console.error('更新經濟指標失敗:', error);
                    alert('更新經濟指標失敗');
                    $('#message').text('更新經濟指標失敗：' + xhr.responseText);
                }
            });
        }
    </script>
</body>
</html>
